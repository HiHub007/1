local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local Workspace = game:GetService("Workspace")
local SoundService = game:GetService("SoundService")
local Player = Players.LocalPlayer
local PlayerGui = Player:WaitForChild("PlayerGui")

-- ====================== Persistent GUI ======================
local function createMainGUI()
	if PlayerGui:FindFirstChild("PersistentGUI") then
		return PlayerGui.PersistentGUI
	end
	local gui = Instance.new("ScreenGui")
	gui.Name = "PersistentGUI"
	gui.ResetOnSpawn = false
	gui.Parent = PlayerGui
	return gui
end
local mainGui = createMainGUI()

-- ====================== Toggle Button ======================
local toggleBtn = mainGui:FindFirstChild("ToggleBtn")
if not toggleBtn then
	toggleBtn = Instance.new("TextButton")
	toggleBtn.Name = "ToggleBtn"
	toggleBtn.Size = UDim2.new(0,60,0,40)
	toggleBtn.Position = UDim2.new(0.5, -30, 0, 10)
	toggleBtn.BackgroundColor3 = Color3.fromRGB(50,50,50)
	toggleBtn.TextColor3 = Color3.fromRGB(255,255,255)
	toggleBtn.Text = "GUI"
	toggleBtn.Parent = mainGui
end

-- ====================== Main Frame ======================
local frame = mainGui:FindFirstChild("MainFrame")
if not frame then
	frame = Instance.new("Frame")
	frame.Name = "MainFrame"
	frame.Size = UDim2.new(0,240,0,280)
	frame.Position = UDim2.new(0.5, -120, 0, 70)
	frame.BackgroundColor3 = Color3.fromRGB(30,30,30)
	frame.Visible = false
	frame.Active = true
	frame.Draggable = true
	frame.Parent = mainGui
end

local guiOpen = false
toggleBtn.MouseButton1Click:Connect(function()
	guiOpen = not guiOpen
	frame.Visible = guiOpen
end)

-- ====================== XRay ทั้งโมเดล + Part เดี่ยว ======================
local xrayEnabled = false

local function applyXray(obj)
    local rarity
    if obj:IsA("Model") then
        rarity = obj:GetAttribute("Rarity")
        if rarity ~= "Common" and rarity ~= "Uncommon" then return end
        -- ลูปทุก BasePart ในโมเดล
        for _, part in ipairs(obj:GetDescendants()) do
            if part:IsA("BasePart") then
                part.LocalTransparencyModifier = xrayEnabled and 0.8 or 0
            end
        end
    elseif obj:IsA("BasePart") then
        rarity = obj:GetAttribute("Rarity")
        if rarity ~= "Common" and rarity ~= "Uncommon" then return end
        obj.LocalTransparencyModifier = xrayEnabled and 0.85 or 0
    end
end

local function updateXray()
    local midFolder = Workspace:FindFirstChild("Mid")
    if not midFolder then return end
    local blocksFolder = midFolder:FindFirstChild("Blocks")
    if not blocksFolder then return end

    for _, obj in ipairs(blocksFolder:GetChildren()) do
        applyXray(obj)
    end
end

-- เพิ่ม DescendantAdded เพื่อตรวจ Part/Model ใหม่
Workspace.DescendantAdded:Connect(function(obj)
    if not xrayEnabled then return end
    if obj.Parent and obj.Parent.Name == "Blocks" then
        applyXray(obj)
    end
end)

-- XRay Toggle Button
local xrayBtn = frame:FindFirstChild("XRayBtn")
if not xrayBtn then
    xrayBtn = Instance.new("TextButton")
    xrayBtn.Name = "XRayBtn"
    xrayBtn.Size = UDim2.new(0,200,0,35)
    xrayBtn.Position = UDim2.new(0.5, -100, 0, 10)
    xrayBtn.Text = "XRay: OFF"
    xrayBtn.BackgroundColor3 = Color3.fromRGB(50,50,50)
    xrayBtn.TextColor3 = Color3.fromRGB(255,255,255)
    xrayBtn.Parent = frame
end

xrayBtn.MouseButton1Click:Connect(function()
    xrayEnabled = not xrayEnabled
    xrayBtn.Text = "XRay: "..(xrayEnabled and "ON" or "OFF")
    updateXray()
end)

-- ====================== ESP ======================
local espEnabled = true
local espModels = {}
local rarityColors = {
    ["Legendary"] = Color3.fromRGB(193,190,66),
    ["Mythic"] = Color3.fromRGB(255,0,0),
    ["Divine"] = Color3.fromRGB(207,96,36)
}

-- สร้าง ESP แบบไฮไลท์ขอบทุก Part ในโมเดล
local function createESP(model, rarity, name)
    if espModels[model] then return end
    if not model:IsA("Model") then return end

    -- สร้าง Highlight แทน BoxHandleAdornment
    local highlight = Instance.new("Highlight")
    highlight.Adornee = model
    highlight.FillTransparency = 1        -- ใส่ 1 เพื่อไม่ให้เต็มสี
    highlight.OutlineTransparency = 0    -- 0 เพื่อให้เห็นขอบ
    highlight.OutlineColor = rarityColors[rarity] or Color3.new(1,1,1)
    highlight.Parent = model

    local mainPart = model.PrimaryPart or model:FindFirstChildWhichIsA("BasePart")
    if mainPart then
        local billboard = Instance.new("BillboardGui")
        billboard.Size = UDim2.new(0,90,0,25)
        billboard.Adornee = mainPart
        billboard.AlwaysOnTop = true
        billboard.Parent = mainPart

        local label = Instance.new("TextLabel")
        label.Size = UDim2.new(1,0,1,0)
        label.BackgroundTransparency = 1
        label.TextColor3 = rarityColors[rarity] or Color3.new(1,1,1)
        label.TextStrokeTransparency = 0
        label.TextScaled = true
        label.Text = name or "Unknown"
        label.Parent = billboard

        espModels[model] = {highlight=highlight, label=label}
    end
end

-- ลบ ESP ทั้งหมด
local function removeAllESP()
    for _, data in pairs(espModels) do
        if data.boxes then
            for _, box in ipairs(data.boxes) do
                if box then box:Destroy() end
            end
        end
        if data.label then data.label:Destroy() end
    end
    espModels = {}
end

-- ตรวจทุก 3 วินาที
local lastCheck = 0
local checkInterval = 3
RunService.Heartbeat:Connect(function()
    if not espEnabled then return end
    local now = tick()
    if now - lastCheck < checkInterval then return end
    lastCheck = now

    local midFolder = Workspace:FindFirstChild("Mid")
    if not midFolder then return end
    local blocksFolder = midFolder:FindFirstChild("Blocks")
    if not blocksFolder then return end

    for _, model in ipairs(blocksFolder:GetChildren()) do
        if model:IsA("Model") then
            local rarity = model:GetAttribute("Rarity")
            local name = model:GetAttribute("Name") or model.Name
            if rarity and rarityColors[rarity] then
                createESP(model, rarity, name)
            end

            -- ลบ ESP ถ้าโมเดลถูกลบ
            model.AncestryChanged:Connect(function(_, parent)
                if not parent then
                    if espModels[model] then
                        removeAllESP(model)
                        espModels[model] = nil
                    end
                end
            end)
        end
    end
end)

-- ====================== ESP Toggle Button ======================
local espBtn = frame:FindFirstChild("ESPBtn")
if not espBtn then
    espBtn = Instance.new("TextButton")
    espBtn.Name = "ESPBtn"
    espBtn.Size = UDim2.new(0,200,0,35)
    espBtn.Position = UDim2.new(0.5,-100,0,55)
    espBtn.Text = "ESP: ON"
    espBtn.BackgroundColor3 = Color3.fromRGB(0,0,0)
    espBtn.TextColor3 = Color3.fromRGB(255,255,255)
    espBtn.Parent = frame
end

espBtn.MouseButton1Click:Connect(function()
    espEnabled = not espEnabled
    espBtn.Text = "ESP: "..(espEnabled and "ON" or "OFF")
    if not espEnabled then removeAllESP() end
end)


-- ====================== Save/Warp ✅ Spawn Saved! ======================
local savedCFrame
local saveBtn = Instance.new("TextButton", frame)
saveBtn.Size = UDim2.new(0,200,0,35)
saveBtn.Position = UDim2.new(0.5, -100, 0, 100)
saveBtn.Text = "Save Spawn"
saveBtn.BackgroundColor3 = Color3.fromRGB(50,150,50)
saveBtn.TextColor3 = Color3.fromRGB(255,255,255)
saveBtn.MouseButton1Click:Connect(function()
	local character = Player.Character
	if character then
		local hrp = character:FindFirstChild("HumanoidRootPart")
		if hrp then
			savedCFrame = hrp.CFrame
			saveBtn.Text = "Spawn Saved!"
			task.delay(1.2, function()
				saveBtn.Text = "Save Spawn"
			end)
		end
	end
end)

local warpBtn = Instance.new("TextButton", frame)
warpBtn.Size = UDim2.new(0,200,0,35)
warpBtn.Position = UDim2.new(0.5, -100, 0, 145)
warpBtn.Text = "Warp Spawn"
warpBtn.BackgroundColor3 = Color3.fromRGB(50,50,150)
warpBtn.TextColor3 = Color3.fromRGB(255,255,255)
warpBtn.MouseButton1Click:Connect(function()
	local character = Player.Character
	if character and savedCFrame then
		local hrp = character:FindFirstChild("HumanoidRootPart")
		if hrp then hrp.CFrame = savedCFrame end
	end
end)

-- ====================== ALERT (Prismatic) ======================
local Character = Player.Character or Player.CharacterAdded:Wait()
local alertEnabled = true
local alerted = {}
local lastSound = 0
local cooldown = 2

local alertTargets = {
	["Grass"] = false,
	["Lucky Block"] = true,
	["Diamond Lucky Block"] = true,
	["Beacon Crate"] = true,
	["Prismatic Ore"] = true,
	["Prismatic Block"] = true,
}

local alertBtn = Instance.new("TextButton", frame)
alertBtn.Size = UDim2.new(0,200,0,35)
alertBtn.Position = UDim2.new(0.5, -100, 0, 190)
alertBtn.Text = "ALERT: ON"
alertBtn.BackgroundColor3 = Color3.fromRGB(150,50,50)
alertBtn.TextColor3 = Color3.new(1,1,1)

alertBtn.MouseButton1Click:Connect(function()
	alertEnabled = not alertEnabled
	alertBtn.Text = "ALERT: " .. (alertEnabled and "ON" or "OFF")
end)

local function playAlert()
	local s = Instance.new("Sound")
	s.SoundId = "rbxassetid://7695856187"
	s.Volume = 10
	s.PlayOnRemove = true
	s.Parent = SoundService
	s:Destroy()
end

local function safeName(obj)
	local ok,value = pcall(function() return obj:GetAttribute("Name") end)
	if ok and typeof(value)=="string" and #value>0 then return value end
	return obj.Name
end

local function tryAlert(obj)
	if not alertEnabled then return end
	if alerted[obj] or obj:IsDescendantOf(Character) then return end

	local mid = Workspace:FindFirstChild("Mid")
	if not mid or not obj:IsDescendantOf(mid) then return end

	local name = safeName(obj)
	if alertTargets[name] then
		alerted[obj] = true
		if os.clock() - lastSound >= cooldown then
			lastSound = os.clock()
			playAlert()
		end
	end
end

for _, inst in ipairs(Workspace:GetDescendants()) do
	task.defer(tryAlert, inst)
end
Workspace.DescendantAdded:Connect(function(inst)
	task.defer(tryAlert, inst)
end)

print("✅ Script Loaded: XRay Updated + ESP Original + Prismatic Alert + Spawn Saved! ✅")
