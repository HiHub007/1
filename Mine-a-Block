local RunService = game:GetService("RunService")
local Workspace = game:GetService("Workspace")
local Players = game:GetService("Players")
local Player = Players.LocalPlayer
local PlayerGui = Player:WaitForChild("PlayerGui")

local xrayColors = {
Color3.fromRGB(108,88,75),Color3.fromRGB(120,97,83),
Color3.fromRGB(75,151,75),Color3.fromRGB(75,151,75),
Color3.fromRGB(100,100,100),Color3.fromRGB(89,18,18),
Color3.fromRGB(132,26,26),Color3.fromRGB(109,22,22),
Color3.fromRGB(58,117,58),Color3.fromRGB(58,117,58),
Color3.fromRGB(65,130,65),Color3.fromRGB(142,110,78),
Color3.fromRGB(188,169,136)
}
local xrayEnabled = false
local function isXray(part) for _,c in ipairs(xrayColors) do if part.Color==c then return true end end return false end
local function updateXray()
    for _,o in pairs(workspace:GetDescendants()) do
        if o:IsA("BasePart") and isXray(o) then
            o.LocalTransparencyModifier = xrayEnabled and 0.8 or 0
        end
    end
end

local RunService = game:GetService("RunService")
local Workspace = game:GetService("Workspace")
local Players = game:GetService("Players")

local Player = Players.LocalPlayer
local PlayerGui = Player:WaitForChild("PlayerGui")

local espEnabled = true
local espModels = {}

-- GUI toggle
local screenGui = Instance.new("ScreenGui", PlayerGui)
local toggleButton = Instance.new("TextButton")
toggleButton.Size = UDim2.new(0,120,0,40)
toggleButton.Position = UDim2.new(0,20,0,20)
toggleButton.Text = "ESP: ON"
toggleButton.BackgroundColor3 = Color3.fromRGB(0,0,0)
toggleButton.TextColor3 = Color3.fromRGB(255,255,255)
toggleButton.Parent = screenGui

toggleButton.MouseButton1Click:Connect(function()
    espEnabled = not espEnabled
    toggleButton.Text = "ESP: "..(espEnabled and "ON" or "OFF")
    if not espEnabled then
        for _, data in pairs(espModels) do
            if data.box then data.box:Destroy() end
            if data.label then data.label:Destroy() end
        end
        espModels = {}
    end
end)

-- สีตาม Rarity
local rarityColors = {
    ["Legendary"] = Color3.fromRGB(255,215,0),
    ["Mythic"] = Color3.fromRGB(148,0,211),
    ["Divine"] = Color3.fromRGB(0,191,255)
}

-- สร้าง ESP + ชื่อ
local function createESP(model, part, rarity, name)
    if espModels[model] then return end
    if not part then return end

    -- Box ESP
    local box = Instance.new("BoxHandleAdornment")
    box.Adornee = part
    box.Size = part.Size + Vector3.new(0.1,0.1,0.1)
    box.Transparency = 0.75
    box.AlwaysOnTop = true
    box.Color3 = rarityColors[rarity] or part.Color
    box.Parent = part

    -- ชื่อเหนือบล็อก
    local billboard = Instance.new("BillboardGui")
    billboard.Size = UDim2.new(0,100,0,30)
    billboard.Adornee = part
    billboard.AlwaysOnTop = true
    billboard.Parent = part

    local label = Instance.new("TextLabel")
    label.Size = UDim2.new(1,0,1,0)
    label.BackgroundTransparency = 1
    label.TextColor3 = rarityColors[rarity] or Color3.new(1,1,1)
    label.TextStrokeTransparency = 0
    label.Text = name or "Unknown"
    label.TextScaled = true
    label.Parent = billboard

    espModels[model] = {box = box, label = label}
end

local function removeESP(model)
    if espModels[model] then
        if espModels[model].box then espModels[model].box:Destroy() end
        if espModels[model].label then espModels[model].label:Destroy() end
        espModels[model] = nil
    end
end

-- ตรวจทีละ 3 วินาที
local lastCheck = 0
local checkInterval = 3

RunService.Heartbeat:Connect(function()
    if not espEnabled then return end
    local now = tick()
    if now - lastCheck < checkInterval then return end
    lastCheck = now

    local midFolder = Workspace:FindFirstChild("Mid")
    if not midFolder then return end
    local blocksFolder = midFolder:FindFirstChild("Blocks")
    if not blocksFolder then return end

    for _, model in ipairs(blocksFolder:GetChildren()) do
        if model:IsA("Model") then
            local rarity = model:GetAttribute("Rarity")
            local name = model:GetAttribute("Name")
            if rarity and name and rarityColors[rarity] then
                local part = model:FindFirstChild("Top") or model.PrimaryPart or model:FindFirstChildWhichIsA("BasePart")
                if part then
                    createESP(model, part, rarity, name)
                end
            end

            model.AncestryChanged:Connect(function(_, parent)
                if not parent then removeESP(model) end
            end)
        end
    end
end)

